# Template for building Ghostty on Void Linux

pkgname=ghostty-tip
version=1.3.0
revision=1
maintainer="ItsLemmy <studio@quadbyte.net>"
short_desc="Fast and feature-rich terminal emulator that uses GPU acceleration (release)"
license="MIT"
homepage="https://ghostty.org/"

_zig_version=0.15.2

# Dependencies that are required to build and run the package
makedepends="gtk4-devel gtk4-layer-shell-devel libadwaita-devel pkg-config gettext"
hostmakedepends="curl tar xz blueprint-compiler"

do_extract() {
    local srcdir="${XBPS_SRCDISTDIR}/${pkgname}-${version}"
    
    # Create source directory if it doesn't exist
    mkdir -p "${srcdir}"
    
    # Download Ghostty source if not already present
    msg_normal "Downloading Ghostty source...\n"
    cd "${srcdir}"
    curl -L "https://github.com/ghostty-org/ghostty/releases/download/tip/ghostty-source.tar.gz" \
        -o ghostty-source.tar.gz || msg_error "Failed to download Ghostty source\n"
    
    # Download Zig if not already present
    if [ ! -f "${srcdir}/zig-x86_64-linux-${_zig_version}.tar.xz" ]; then
        msg_normal "Downloading Zig ${_zig_version}...\n"
        cd "${srcdir}"
        curl -L "https://ziglang.org/download/${_zig_version}/zig-x86_64-linux-${_zig_version}.tar.xz" \
            -o zig-x86_64-linux-${_zig_version}.tar.xz || msg_error "Failed to download Zig\n"
    fi
    
    # Create and enter work directory
    mkdir -p ${wrksrc}
    cd ${wrksrc}
    
    # Extract Ghostty source
    msg_normal "Extracting Ghostty source...\n"
    tar -xf "${srcdir}/ghostty-source.tar.gz" --strip-components=1
    
    # Extract Zig
    msg_normal "Extracting Zig...\n"
    tar -xf "${srcdir}/zig-x86_64-linux-${_zig_version}.tar.xz"
}

do_build() {
    local srcdir="${XBPS_SRCDISTDIR}/${pkgname}-${version}"
    cd ${wrksrc}

    # Extract Zig if not already present in wrksrc
    if [ ! -d "zig-x86_64-linux-${_zig_version}" ]; then
        msg_normal "Extracting Zig...\n"
        tar -xf "${srcdir}/zig-x86_64-linux-${_zig_version}.tar.xz"
    fi

    # Run the build using Zig with PIE enabled
    # -Demit-themes=false: Skip downloading iTerm2 color schemes (URL may be outdated)
    ./zig-x86_64-linux-${_zig_version}/zig build -Doptimize=ReleaseFast -Dpie=true -Demit-themes=false
}

do_install() {
    # Install the compiled binary
    vinstall zig-out/bin/ghostty 755 usr/bin

    # Install desktop file and fix hardcoded build paths
    vinstall zig-out/share/applications/com.mitchellh.ghostty.desktop 644 usr/share/applications
    vsed -i -e "s|${wrksrc}/zig-out/bin/ghostty|/usr/bin/ghostty|g" \
        ${DESTDIR}/usr/share/applications/com.mitchellh.ghostty.desktop

    # Install KDE servicemenu and fix hardcoded build paths
    vinstall zig-out/share/kio/servicemenus/com.mitchellh.ghostty.desktop 644 usr/share/kio/servicemenus
    vsed -i -e "s|${wrksrc}/zig-out/bin/ghostty|/usr/bin/ghostty|g" \
        ${DESTDIR}/usr/share/kio/servicemenus/com.mitchellh.ghostty.desktop

    # Install icons
    for size in 16 32 128 256 512 1024; do
        vinstall zig-out/share/icons/hicolor/${size}x${size}/apps/com.mitchellh.ghostty.png 644 \
            usr/share/icons/hicolor/${size}x${size}/apps
    done

    # Install HiDPI icons
    for size in 16 32 128 256; do
        vinstall zig-out/share/icons/hicolor/${size}x${size}@2/apps/com.mitchellh.ghostty.png 644 \
            usr/share/icons/hicolor/${size}x${size}@2/apps
    done

    # Install shell completions
    vinstall zig-out/share/bash-completion/completions/ghostty.bash 644 usr/share/bash-completion/completions ghostty
    vinstall zig-out/share/fish/vendor_completions.d/ghostty.fish 644 usr/share/fish/vendor_completions.d
    vinstall zig-out/share/zsh/site-functions/_ghostty 644 usr/share/zsh/site-functions

    # Install shell integration
    vmkdir usr/share/ghostty/shell-integration
    vcopy zig-out/share/ghostty/shell-integration/* usr/share/ghostty/shell-integration

    # Install vim/neovim syntax files
    vmkdir usr/share/vim/vimfiles
    vcopy zig-out/share/vim/vimfiles/* usr/share/vim/vimfiles
    vmkdir usr/share/nvim/site
    vcopy zig-out/share/nvim/site/* usr/share/nvim/site

    # Install bat syntax
    vinstall zig-out/share/bat/syntaxes/ghostty.sublime-syntax 644 usr/share/bat/syntaxes

    # Install metainfo
    vinstall zig-out/share/metainfo/com.mitchellh.ghostty.metainfo.xml 644 usr/share/metainfo

    # Install D-Bus service
    vinstall zig-out/share/dbus-1/services/com.mitchellh.ghostty.service 644 usr/share/dbus-1/services

    # Install systemd user service
    vinstall zig-out/share/systemd/user/app-com.mitchellh.ghostty.service 644 usr/lib/systemd/user

    # Install nautilus extension
    vinstall zig-out/share/nautilus-python/extensions/ghostty.py 644 usr/share/nautilus-python/extensions

    # Install terminfo files
    vinstall zig-out/share/terminfo/g/ghostty 644 usr/share/terminfo/g
    vinstall zig-out/share/terminfo/x/xterm-ghostty 644 usr/share/terminfo/x

    # Install locale files
    for locale_dir in zig-out/share/locale/*/LC_MESSAGES; do
        if [ -f "${locale_dir}/com.mitchellh.ghostty.mo" ]; then
            locale_name=$(basename $(dirname $(dirname ${locale_dir})))
            vmkdir usr/share/locale/${locale_name}/LC_MESSAGES
            vinstall ${locale_dir}/com.mitchellh.ghostty.mo 644 \
                usr/share/locale/${locale_name}/LC_MESSAGES
        fi
    done

    # Install library
    vinstall zig-out/lib/libghostty-vt.so.0.1.0 755 usr/lib
    ln -sf libghostty-vt.so.0.1.0 ${DESTDIR}/usr/lib/libghostty-vt.so.0
    ln -sf libghostty-vt.so.0.1.0 ${DESTDIR}/usr/lib/libghostty-vt.so

    # Install headers
    vmkdir usr/include/ghostty/vt/key
    vinstall zig-out/include/ghostty/vt.h 644 usr/include/ghostty
    vcopy zig-out/include/ghostty/vt/* usr/include/ghostty/vt

    # Install pkgconfig
    vinstall zig-out/share/pkgconfig/libghostty-vt.pc 644 usr/lib/pkgconfig
}
