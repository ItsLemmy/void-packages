# Template file for 'vscode-microsoft'
pkgname=vscode-microsoft
version=1.107.0
revision=1
archs="x86_64"
hostmakedepends="tar curl"
depends="libXtst libXScrnSaver nss gtk+3 alsa-lib"
short_desc="Visual Studio Code - Code editing. Redefined"
maintainer="ItsLemmy <studio@quadbyte.net>"
license="custom:Microsoft"
homepage="https://code.visualstudio.com/"
distfiles="https://code.visualstudio.com/sha/download?build=stable&os=linux-x64>vscode-${version}.tar.gz"
checksum=9cf13545117c297dce550eb187795c608a6bdad1d6acbc8450daceb6e06cbdbd
repository=nonfree
restricted=yes
nopie=yes

do_extract() {
    mkdir -p "${wrksrc}"
    tar -xzf "${XBPS_SRCDISTDIR}/${pkgname}-${version}/vscode-${version}.tar.gz" \
        -C "${wrksrc}" --strip-components=1
}

do_install() {
    # Install everything to /opt/vscode
    vmkdir opt/vscode
    vcopy "*" opt/vscode

    # Create wrapper script in /usr/bin
    vmkdir usr/bin
    cat > "${DESTDIR}/usr/bin/code" <<'EOF'
#!/bin/sh
exec /opt/vscode/bin/code "$@"
EOF
    chmod +x "${DESTDIR}/usr/bin/code"

    # Install desktop entry
    vmkdir usr/share/applications
    cat > "${DESTDIR}/usr/share/applications/code.desktop" <<'EOF'
[Desktop Entry]
Name=Visual Studio Code
Keywords=web;development;code;api;text;editor
Exec=/opt/vscode/bin/code %u
Icon=/opt/vscode/resources/app/resources/linux/code.png
Terminal=false
Type=Application
StartupWMClass=Visual Studio Code
Categories=Development;TextEditor;Utility;
Actions=new-empty-window;

[Desktop Action new-empty-window]
Name=New Empty Window
Exec=/opt/vscode/bin/code --new-window %F
Icon=/opt/vscode/resources/app/resources/linux/code.png
EOF
}
